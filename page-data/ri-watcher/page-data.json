{"componentChunkName":"component---src-templates-blog-template-js","path":"/ri-watcher/","result":{"data":{"cur":{"id":"c4a57922-7052-541c-a585-2429f656d430","html":"<p><img src=\"~@img/ri-watcher/ri-watcher-sc.png\" alt=\"~@img/ri-watcher/ri-watcher-sc.png\"></p>\n<h1 id=\"0-목적\" style=\"position:relative;\"><a href=\"#0-%EB%AA%A9%EC%A0%81\" aria-label=\"0 목적 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>0. 목적</h1>\n<p>AWS RI 리소스들의 Retired 날짜를 잊고 지내다가, 제때 재구매를 하지 못해 Ondemand 비용을 지불하고 사용하는 경우를 방지하기 위해 만들어졌습니다.</p>\n<h1 id=\"1-작동\" style=\"position:relative;\"><a href=\"#1-%EC%9E%91%EB%8F%99\" aria-label=\"1 작동 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 작동</h1>\n<ul>\n<li>EC2, RDS, ElastiCache, ElasticSearch, Redshift의 RI를 다룹니다.</li>\n<li>cron()이나 rate() 표기식으로 RI 만기일이 체크 주기를 정할 수 있습니다.</li>\n<li>Slack으로 알림을 줍니다.</li>\n</ul>\n<h1 id=\"2-code-classlanguage-textsettingymlcode\" style=\"position:relative;\"><a href=\"#2-code-classlanguage-textsettingymlcode\" aria-label=\"2 code classlanguage textsettingymlcode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. <code class=\"language-text\">setting.yml</code></h1>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">SLACK_WEBHOOK_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token comment\"># SLACK WEBHOOK URL</span>\n<span class=\"token key atrule\">SCHEDULE</span><span class=\"token punctuation\">:</span> cron(0 1 * * <span class=\"token punctuation\">?</span> <span class=\"token important\">*)</span> <span class=\"token comment\"># cron() or rate()</span>\n<span class=\"token key atrule\">PROFILE</span><span class=\"token punctuation\">:</span> default <span class=\"token comment\"># AWS Profile in your local</span>\n<span class=\"token key atrule\">REGION</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">2</span> <span class=\"token comment\"># Target region</span></code></pre></div>\n<ul>\n<li>SLACK_WEBHOOK_URL : 슬랙 웹훅 URL 을 기입합니다.</li>\n<li>SCHEDULE : cron(), rate() 표현식으로 봇이 얼마 주기로 RI 만기일을 체크할지 정합니다.</li>\n<li>PROFILE : 본 코드를 Deploy할 AWS Profile을 정합니다. 또한 해당 Profile의 RI 리소스를 검사합니다.</li>\n<li>REGION : 타겟 리전을 정합니다. (서울은 <code class=\"language-text\">ap-northeast-2</code>)</li>\n</ul>\n<h1 id=\"그-외\" style=\"position:relative;\"><a href=\"#%EA%B7%B8-%EC%99%B8\" aria-label=\"그 외 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그 외</h1>\n<p>RI Watcher는 Serverless Framework를 이용하여 만들어졌으며 기본적으로 Serverless Framework가 설치되어 있는 환경에서 deploy 가능합니다.</p>","excerpt":"~@img/ri-watcher/ri-watcher-sc.png 0. 목적 AWS RI 리소스들의 Retired 날짜를 잊고 지내다가, 제때 재구매를 하지 못해 Ondemand 비용을 지불하고 사용하는 경우를 방지하기 위해 만들어졌습니다. 1. 작동 EC2, RDS, ElastiCache, ElasticSearch, Redshift의 RI를 다룹니다. cron()이나 rate() 표기식으로 RI 만기일이 체크 주기를 정할 수 있습니다. Slack으로 알림을 줍니다. 2.  SLACK_WEBHOOK_URL : 슬랙 웹훅 URL 을 기입합니다. SCHEDULE : cron(), rate() 표현식으로 봇이 얼마 주기로 RI 만기일을 체크할지 정합니다. PROFILE : 본 코드를 Deploy할 AWS Profile을 정합니다. 또한 해당 Profile의 RI 리소스를 검사합니다. REGION : 타겟 리전을 정합니다. (서울은 ) 그 외 RI Watcher는 Serverless Fram…","frontmatter":{"date":"January 01, 2022","title":"RI Watcher","categories":"craft","author":"신나라","emoji":"🔨"},"fields":{"slug":"/ri-watcher/"}},"next":{"id":"1023ff97-58ca-5ea9-bbc4-e8c86a965387","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVQoz52SS2/TQBSF89/5H92wZRUJFlRsKCs2KAmiSpuapITGNn40L4/ncedDsZ1JTKsKuNJ4rPGdb84ZnwFnpbVuZu99GP9ag+OmPM8ZDodUVRWg/1MBaIwhiiLW6/WzKv/2gMGxuSgK4jgmyzKcc72mE7R7nMH/PDQoTNO0AR5ghzVrbaP6MPeh0lPvRZq1ADy8iBfSJGF6uyArFXslLB+yZihlTsAXbB+hDdBZYVPueFgmpHFO3UG0Nry6+Mh630GB3dUHzHKBFo9xnuTygmr8vv0urgVaLaxWMZOvE66/XVPt6qZhs93y7mpCXrY/yonwczziMYmxzrFXNfPL15TTz0FlABZ5SRTdMZ8vUHvd3ZEcDTUwEenZFHHUAsq45i6DZaMFVSlms1vKssQZ3xr0nrdfLDerE2h0XzNZqBboeZKGoHC73jO7+c6vJEdtLVpZ1E7z5lPJ+G4H1lFtKkbTmNmP4oDrEtTPa8ihNcJjWmFqh8hZmL0GaaOjjaHIEoosxVr3bOB/A854pxdRNqG9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"efish-architecture\"\n        title=\"efish-architecture\"\n        src=\"/static/227c370838b062ddaa19856caceca58e/37523/efish-architecture.png\"\n        srcset=\"/static/227c370838b062ddaa19856caceca58e/e9ff0/efish-architecture.png 180w,\n/static/227c370838b062ddaa19856caceca58e/f21e7/efish-architecture.png 360w,\n/static/227c370838b062ddaa19856caceca58e/37523/efish-architecture.png 720w,\n/static/227c370838b062ddaa19856caceca58e/302a4/efish-architecture.png 1080w,\n/static/227c370838b062ddaa19856caceca58e/07a9c/efish-architecture.png 1440w,\n/static/227c370838b062ddaa19856caceca58e/3a5d5/efish-architecture.png 1807w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>","frontmatter":{"date":"January 01, 2022","title":"Efish","categories":"craft","author":"신나라","emoji":"🔨"},"fields":{"slug":"/efish/"}},"prev":{"id":"3f04f744-98a7-5238-977e-0def1fea31f5","html":"<h2 id=\"a-cloudflare-의-advanced-ddos-를-이용한-방어-전략\" style=\"position:relative;\"><a href=\"#a-cloudflare-%EC%9D%98-advanced-ddos-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B0%A9%EC%96%B4-%EC%A0%84%EB%9E%B5\" aria-label=\"a cloudflare 의 advanced ddos 를 이용한 방어 전략 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A. Cloudflare 의 Advanced DDoS 를 이용한 방어 전략</h2>\n<ol>\n<li>봇넷을 통해 공격이 들어오면 데이터베이스에 부하가 발생하고, 서비스 요청이 정상적으로 처리되지 않는다</li>\n<li>서비스 운영자는 이를 확인하고 Cloudflare 에서 <strong>I’m Under Attack</strong> 모드를 활성화한다</li>\n<li>하지만 언젠가부터 <strong>I’m Under Attack</strong> 을 통과하는 방식의 공격이 발생하였다</li>\n<li>이를 방어하기 위해서 <strong>Rate Limiting</strong> 을 사용하여 방어하려고 하였으나, <strong>Rate Limit</strong> 집계 시점 이전에 이미 방대한 요청이 들어오기 때문에, <strong>능동 방어에는 시간이 걸린다(1분 이상)</strong></li>\n</ol>\n<h2 id=\"b-aws-waf-security-automations-template을-이용한-방어-전략\" style=\"position:relative;\"><a href=\"#b-aws-waf-security-automations-template%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B0%A9%EC%96%B4-%EC%A0%84%EB%9E%B5\" aria-label=\"b aws waf security automations template을 이용한 방어 전략 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>B. AWS WAF Security Automations Template을 이용한 방어 전략</h2>\n<p><img src=\"~@img/shieldee/waf-securityAutomationtemplate.png\" alt=\"\"></p>\n<ol>\n<li>봇넷을 통해 공격이 들어오면 데이터베이스에 부하가 발생하고, 서비스 요청이 정상적으로 처리되지 않는다</li>\n<li>CloudFront 또는 Application Load Balancer 에서 Access Logs 를 활성화하고, S3에 저장하도록 한다</li>\n<li>S3에 Access Log가 적재된 이후에, Amazon Athena 가 해당 로그를 <strong>5분 단위로 집계</strong>하여, 지정한 요청 임계치를 초과한 IP들을 AWS WAF IP Set에 추가한다</li>\n</ol>\n<ul>\n<li>마찬가지로 집계 시점 이전에 이미 방대한 요청이 들어오므로, <strong>대응이 느리다(5분 이상)</strong></li>\n</ul>\n<h2 id=\"c-shieldee-의-대응-시나리오\" style=\"position:relative;\"><a href=\"#c-shieldee-%EC%9D%98-%EB%8C%80%EC%9D%91-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"c shieldee 의 대응 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>C. Shieldee 의 대응 시나리오</h2>\n<p><img src=\"~@img/shieldee/shieldee.png\" alt=\"\"></p>\n<ol>\n<li>봇넷을 통해 공격이 들어오면 앞단 NGINX 에서 지정된 Rate Limiting 정책에 해당하는 개별 IP들을 에러 로그로 떨어뜨린다.</li>\n<li>해당 에러 로그를 탐지하자마자 곧바로 엣지 WAF 에 룰셋으로 해당 IP를 블락한다.\n<ul>\n<li>엣지 영역에서 블락하지 못한 트래픽들을 위한 최후방어선으로 동작하며,</li>\n<li><strong>Rate Limiting 탐지 이후 3초 안에 블락한다.</strong></li>\n</ul>\n</li>\n<li>일시적인 오탐 등을 고려하여 1시간 뒤에 해당 IP들을 해제한다.</li>\n</ol>\n<h2 id=\"2-동작-방식\" style=\"position:relative;\"><a href=\"#2-%EB%8F%99%EC%9E%91-%EB%B0%A9%EC%8B%9D\" aria-label=\"2 동작 방식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 동작 방식</h2>\n<ol>\n<li>봇넷을 통해 공격이 들어오면, NGINX 의 <strong>Rate Limiting</strong> 기능으로 개별 IP들의 초당 요청 수를 제한하도록 한다\n<ol>\n<li>이 때의 <strong>Rate Limiting</strong> 대상은 동적 컨텐츠 요청 영역으로만 한정한다</li>\n</ol>\n</li>\n<li><strong>Rate Limiting</strong> 에 적용된 IP 들은 NGINX 에러 로그 파일로 기록이 된다.</li>\n<li><strong>fluentd</strong> 로 에러 로그를 테일링(Tailing) 하여, <strong>Rate Limiting</strong> 로그 형식에 맞춰서 정규표현식으로 캡처를 한다</li>\n<li>캡처된 내용을 <strong>Amazon Kinesis Data Streams</strong> 로 전달하고,</li>\n<li><strong>Kinesis Data Streams</strong> 에서 트리거링된 <strong>AWS Lambda</strong> 가 동작하여, 전달된 IP를 <strong>DynamoDB</strong>에 기록한다.</li>\n<li>기록된 정보는 <strong>DynamoDB Streams</strong> 로 <strong>AWS Lambda</strong> 에 전달되는데, 이 때 해당 IP를 Cloudflare Access Rule 에 Block 모드로 추가한다\n<ol>\n<li>Access Rule 에 추가하고 반환받은 Access Rule Id를 <strong>DynamoDB</strong> 에 기록한다</li>\n<li>이 때, <code class=\"language-text\">expirationTime</code> 속성을 TTL 로 추가하고, 기본 TTL을 3600(1시간)으로 지정한다.</li>\n</ol>\n</li>\n<li><strong>DynamoDB</strong> 에서 TTL 이 경과된 항목이 삭제되면서, 해당 내용이 <strong>DynamoDB Streams</strong> 을 통해서 <strong>AWS Lambda</strong> 로 트리거링된다.\n<ol>\n<li><strong>DynamoDB</strong> 에 기록된 Access Rule Id 으로 Cloudflare Access Rule 에 등록된 IP를 해제한다</li>\n</ol>\n</li>\n</ol>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#a-cloudflare-%EC%9D%98-advanced-ddos-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B0%A9%EC%96%B4-%EC%A0%84%EB%9E%B5\">A. Cloudflare 의 Advanced DDoS 를 이용한 방어 전략</a></li>\n<li><a href=\"#b-aws-waf-security-automations-template%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B0%A9%EC%96%B4-%EC%A0%84%EB%9E%B5\">B. AWS WAF Security Automations Template을 이용한 방어 전략</a></li>\n<li><a href=\"#c-shieldee-%EC%9D%98-%EB%8C%80%EC%9D%91-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">C. Shieldee 의 대응 시나리오</a></li>\n<li><a href=\"#2-%EB%8F%99%EC%9E%91-%EB%B0%A9%EC%8B%9D\">2. 동작 방식</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 01, 2022","title":"Shieldee","categories":"craft","author":"신나라","emoji":"🔨"},"fields":{"slug":"/shieldee/"}},"site":{"siteMetadata":{"siteUrl":"https://nara.dev","comments":{"utterances":{"repo":"narashin/narashin.github.io"}}}}},"pageContext":{"slug":"/ri-watcher/","nextSlug":"/efish/","prevSlug":"/shieldee/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}